import{o as d,c as i,b as s,d as a,a as l}from"./app.60568e47.js";import{_ as e}from"./plugin-vue_export-helper.21dcd24c.js";const n={},o={"data-v-1605a430":""},r=s("h1",{"data-v-1605a430":"",class:"main-title"}," 05 | \u591A\u8FDB\u7A0B\u89E3\u51B3\u65B9\u6848\uFF1Acluster \u6A21\u5F0F\u4EE5\u53CA PM2 \u5DE5\u5177\u7684\u539F\u7406\u4ECB\u7ECD ",-1),t=a(),c=s("div",{"data-v-1605a430":"",class:"main-tips"},[a(" 2021/03/17 "),s("span",{"data-v-1605a430":"",class:"auth"},"\u6E05\u5F26")],-1),p=a(),v=s("div",{"data-v-1605a430":"",class:"media-player-wrap"},[s("div",{"data-v-6ecd2302":"","data-v-1605a430":""},[s("div",{"data-v-6ecd2302":"",class:"media-container"},[s("div",{"data-v-6ecd2302":"",class:"button-wrap inline-block"},[s("div",{"data-v-6ecd2302":"",class:"button-icon inline-block"})]),a(),s("div",{"data-v-6ecd2302":"",class:"data-wrap inline-block"},[s("div",{"data-v-6ecd2302":"",class:"progress-bar"},[s("div",{class:"vue-slider vue-slider-ltr",style:{padding:"7px 0px",width:"auto",height:"4px"}},[s("div",{class:"vue-slider-rail",style:{height:"2px",background:"rgb(213, 218, 223)","border-radius":"1.5px"}},[s("div",{class:"vue-slider-process",style:{height:"100%",top:"0px",left:"0%",width:"0%","transition-property":"width, left","transition-duration":"0.5s",background:"rgb(252, 215, 102)"}}),s("div",{"aria-valuetext":"00:00/15:56",class:"vue-slider-dot vue-slider-dot-hover",role:"slider","aria-valuenow":"0","aria-valuemin":"0","aria-valuemax":"956","aria-orientation":"horizontal",tabindex:"0",style:{width:"14px",height:"14px",transform:"translate(-50%, -50%)",top:"50%",left:"0%",transition:"left 0.5s ease 0s"}},[s("div",{class:"vue-slider-dot-handle",style:{width:"16px",height:"16px",background:"rgb(252, 215, 102)","box-shadow":"none","margin-top":"-1px","z-index":"1"}}),s("div",{class:"vue-slider-dot-tooltip vue-slider-dot-tooltip-top"},[s("div",{class:"vue-slider-dot-tooltip-inner vue-slider-dot-tooltip-inner-top",style:{padding:"2px 12px","border-radius":"14px","font-size":"14px",color:"rgb(0, 0, 0)",background:"rgb(252, 215, 102)","min-width":"20px","border-color":"rgb(252, 215, 102)"}},[s("span",{class:"vue-slider-dot-tooltip-text"},"00:00/15:56")])])])])])]),a(),s("div",{"data-v-6ecd2302":"",class:"detail-wrap"},[s("div",{"data-v-6ecd2302":"",class:"detail-one"}," 41.57M "),a(),s("div",{"data-v-6ecd2302":"",class:"detail-two"}," 00:00/15:56 ")])]),a(),s("div",{"data-v-6ecd2302":"",class:"division-line inline-block"}),a(),s("div",{"data-v-6ecd2302":"",class:"viedo-wrap inline-block"},[s("div",{"data-v-6ecd2302":"",class:"viedo-icon"}),a(),s("div",{"data-v-6ecd2302":"",class:"text"}," \u770B\u89C6\u9891 ")])])])],-1),h=l(` <div data-v-1605a430="" class="main-container"><div data-v-1605a430="" class="rich-text-wrap"><p data-nodeid="1613" class="">\u524D\u51E0\u8BB2\u6211\u4EEC\u90FD\u4F7F\u7528\u4E86\u4E00\u79CD\u975E\u5E38\u7B80\u5355\u66B4\u529B\u7684\u65B9\u5F0F\uFF08node app.js\uFF09\u542F\u52A8 Node.js \u670D\u52A1\u5668\uFF0C\u800C\u5728\u7EBF\u4E0A\u6211\u4EEC\u8981\u8003\u8651\u4F7F\u7528\u591A\u6838 CPU\uFF0C\u5145\u5206\u5229\u7528\u670D\u52A1\u5668\u8D44\u6E90\uFF0C\u8FD9\u91CC\u5C31\u7528\u5230\u591A\u8FDB\u7A0B\u89E3\u51B3\u65B9\u6848\uFF0C\u6240\u4EE5\u672C\u8BB2\u4ECB\u7ECD PM2 \u7684\u539F\u7406\u4EE5\u53CA\u5982\u4F55\u5E94\u7528\u4E00\u4E2A cluster \u6A21\u5F0F\u542F\u52A8 Node.js \u670D\u52A1\u3002</p><h3 data-nodeid="1614">\u5355\u7EBF\u7A0B\u95EE\u9898</h3><p data-nodeid="1615">\u5728<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=694#/detail/pc?id=6783" data-nodeid="1750">\u300A01 | \u4E8B\u4EF6\u5FAA\u73AF\uFF1A\u9AD8\u6027\u80FD\u5230\u5E95\u662F\u5982\u4F55\u505A\u5230\u7684\uFF1F\u300B</a>\u4E2D\u6211\u4EEC\u5206\u6790\u4E86 Node.js \u4E3B\u7EBF\u7A0B\u662F\u5355\u7EBF\u7A0B\u7684\uFF0C\u5982\u679C\u6211\u4EEC\u4F7F\u7528 node app.js \u65B9\u5F0F\u8FD0\u884C\uFF0C\u5C31\u542F\u52A8\u4E86\u4E00\u4E2A\u8FDB\u7A0B\uFF0C\u53EA\u80FD\u5728<strong data-nodeid="1764">\u4E00\u4E2A CPU \u4E2D\u8FDB\u884C\u8FD0\u7B97</strong>\uFF0C\u65E0\u6CD5\u5E94\u7528\u670D\u52A1\u5668\u7684\u591A\u6838 CPU\uFF0C\u56E0\u6B64\u6211\u4EEC\u9700\u8981\u5BFB\u6C42\u4E00\u4E9B\u89E3\u51B3\u65B9\u6848\u3002\u4F60\u80FD\u60F3\u5230\u7684\u89E3\u51B3\u65B9\u6848\u80AF\u5B9A\u662F<strong data-nodeid="1765">\u591A\u8FDB\u7A0B\u5206\u53D1\u7B56\u7565</strong>\uFF0C\u5373\u4E3B\u8FDB\u7A0B\u63A5\u6536\u6240\u6709\u8BF7\u6C42\uFF0C\u7136\u540E\u901A\u8FC7\u4E00\u5B9A\u7684<strong data-nodeid="1766">\u8D1F\u8F7D\u5747\u8861\u7B56\u7565</strong>\u5206\u53D1\u5230\u4E0D\u540C\u7684 Node.js \u5B50\u8FDB\u7A0B\u4E2D\u3002\u5982\u56FE 1 \u7684\u65B9\u6848\u6240\u793A\uFF1A</p><p data-nodeid="1616"><img src="https://s0.lgstatic.com/i/image6/M01/1D/E0/CioPOWBQKV2ABtnsAAAuF7ZUkEQ818.png" alt="Drawing 1.png" data-nodeid="1769"></p><p data-nodeid="1617">\u8FD9\u4E00\u65B9\u6848\u6709 2 \u4E2A\u4E0D\u540C\u7684\u5B9E\u73B0\uFF1A</p><ul data-nodeid="1618"><li data-nodeid="1619"><p data-nodeid="1620">\u4E3B\u8FDB\u7A0B\u76D1\u542C\u4E00\u4E2A\u7AEF\u53E3\uFF0C\u5B50\u8FDB\u7A0B\u4E0D\u76D1\u542C\u7AEF\u53E3\uFF0C\u901A\u8FC7\u4E3B\u8FDB\u7A0B\u5206\u53D1\u8BF7\u6C42\u5230\u5B50\u8FDB\u7A0B\uFF1B</p></li><li data-nodeid="1621"><p data-nodeid="1622">\u4E3B\u8FDB\u7A0B\u548C\u5B50\u8FDB\u7A0B\u5206\u522B\u76D1\u542C\u4E0D\u540C\u7AEF\u53E3\uFF0C\u901A\u8FC7\u4E3B\u8FDB\u7A0B\u5206\u53D1\u8BF7\u6C42\u5230\u5B50\u8FDB\u7A0B\u3002</p></li></ul><p data-nodeid="1623">\u5728 Node.js \u4E2D\u7684 cluster \u6A21\u5F0F\u4F7F\u7528\u7684\u662F\u7B2C\u4E00\u4E2A\u5B9E\u73B0\u3002</p><h3 data-nodeid="1624">cluster \u6A21\u5F0F</h3><p data-nodeid="1625">cluster \u6A21\u5F0F\u5176\u5B9E\u5C31\u662F\u6211\u4EEC\u4E0A\u9762\u56FE 1 \u6240\u4ECB\u7ECD\u7684\u6A21\u5F0F\uFF0C<strong data-nodeid="1784">\u4E00\u4E2A\u4E3B\u8FDB\u7A0B</strong>\u548C<strong data-nodeid="1785">\u591A\u4E2A\u5B50\u8FDB\u7A0B</strong>\uFF0C\u4ECE\u800C\u5F62\u6210\u4E00\u4E2A\u96C6\u7FA4\u7684\u6982\u5FF5\u3002\u6211\u4EEC\u5148\u6765\u770B\u770B cluster \u6A21\u5F0F\u7684\u5E94\u7528\u4F8B\u5B50\u3002</p><h4 data-nodeid="1626">\u5E94\u7528</h4><p data-nodeid="1627">\u6211\u4EEC\u5148\u5B9E\u73B0\u4E00\u4E2A\u7B80\u5355\u7684 app.js\uFF0C\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="course-code-area"><div class="copy-btn"><div class="copy-icon"></div>\u590D\u5236\u4EE3\u7801</div><pre><code data-language="javascript"><ol><li><div class="code-word"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#39;http&#39;</span>);\r
</div></li><li><div class="code-word"><span class="hljs-comment">/**\r
</span></div></li><li><div class="code-word"> * \r
</div></li><li><div class="code-word"> * \u521B\u5EFA http \u670D\u52A1\uFF0C\u7B80\u5355\u8FD4\u56DE\r
</div></li><li><div class="code-word"> */\r
</div></li><li><div class="code-word"><span class="hljs-keyword">const</span> server = http.createServer(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {\r
</div></li><li><div class="code-word">    res.write(<span class="hljs-string">\`hello world, start with cluster <span class="hljs-subst">\${process.pid}</span>\`</span>);\r
</div></li><li><div class="code-word">    res.end();\r
</div></li><li><div class="code-word">});\r
</div></li><li><div class="code-word"><span class="hljs-comment">/**\r
</span></div></li><li><div class="code-word"> * \r
</div></li><li><div class="code-word"> * \u542F\u52A8\u670D\u52A1\r
</div></li><li><div class="code-word"> */\r
</div></li><li><div class="code-word">server.listen(<span class="hljs-number">3000</span>, () =&gt; {\r
</div></li><li><div class="code-word">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#39;server start http://127.0.0.1:3000&#39;</span>);\r
</div></li><li><div class="code-word">});\r
</div></li><li><div class="code-word"><span class="hljs-built_in">console</span>.log(<span class="hljs-string">\`Worker <span class="hljs-subst">\${process.pid}</span> started\`</span>);\r
</div></li></ol></code></pre></div><p data-nodeid="1629">\u8FD9\u662F\u6700\u7B80\u5355\u7684\u4E00\u4E2A Node.js \u670D\u52A1\uFF0C\u63A5\u4E0B\u6765\u6211\u4EEC\u5E94\u7528 cluster \u6A21\u5F0F\u6765\u5305\u88C5\u8FD9\u4E2A\u670D\u52A1\uFF0C\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="course-code-area"><div class="copy-btn"><div class="copy-icon"></div>\u590D\u5236\u4EE3\u7801</div><pre><code data-language="javascript"><ol><li><div class="code-word"><span class="hljs-keyword">const</span> cluster = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#39;cluster&#39;</span>);\r
</div></li><li><div class="code-word"><span class="hljs-keyword">const</span> instances = <span class="hljs-number">2</span>; <span class="hljs-comment">// \u542F\u52A8\u8FDB\u7A0B\u6570\u91CF</span>\r
</div></li><li><div class="code-word"><span class="hljs-keyword">if</span> (cluster.isMaster) {\r
</div></li><li><div class="code-word">    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>;i&lt;instances;i++) { <span class="hljs-comment">// \u4F7F\u7528 cluster.fork \u521B\u5EFA\u5B50\u8FDB\u7A0B</span>\r
</div></li><li><div class="code-word">        cluster.fork();\r
</div></li><li><div class="code-word">    }\r
</div></li><li><div class="code-word">} <span class="hljs-keyword">else</span> {\r
</div></li><li><div class="code-word">    <span class="hljs-built_in">require</span>(<span class="hljs-string">&#39;./app.js&#39;</span>);\r
</div></li><li><div class="code-word">}\r
</div></li></ol></code></pre></div><p data-nodeid="1631">\u9996\u5148\u5224\u65AD\u662F\u5426\u4E3A\u4E3B\u8FDB\u7A0B\uFF1A</p><ul data-nodeid="1632"><li data-nodeid="1633"><p data-nodeid="1634">\u5982\u679C\u662F\u5219\u4F7F\u7528 cluster.fork \u521B\u5EFA\u5B50\u8FDB\u7A0B\uFF1B</p></li><li data-nodeid="1635"><p data-nodeid="1636">\u5982\u679C\u4E0D\u662F\u5219\u4E3A\u5B50\u8FDB\u7A0B require \u5177\u4F53\u7684 app.js\u3002</p></li></ul><p data-nodeid="1637">\u7136\u540E\u8FD0\u884C\u4E0B\u9762\u547D\u4EE4\u542F\u52A8\u670D\u52A1\u3002</p><div class="course-code-area"><div class="copy-btn"><div class="copy-icon"></div>\u590D\u5236\u4EE3\u7801</div><pre><code data-language="java"><ol><li><div class="code-word">$ node cluster.js\r
</div></li></ol></code></pre></div><p data-nodeid="1639">\u542F\u52A8\u6210\u529F\u540E\uFF0C\u518D\u6253\u5F00\u53E6\u5916\u4E00\u4E2A\u547D\u4EE4\u884C\u7A97\u53E3\uFF0C\u591A\u6B21\u8FD0\u884C\u4EE5\u4E0B\u547D\u4EE4\uFF1A</p><div class="course-code-area"><div class="copy-btn"><div class="copy-icon"></div>\u590D\u5236\u4EE3\u7801</div><pre><code data-language="java"><ol><li><div class="code-word">curl <span class="hljs-string">&quot;http://127.0.0.1:3000/&quot;</span>\r
</div></li></ol></code></pre></div><p data-nodeid="1641">\u4F60\u53EF\u4EE5\u770B\u5230\u5982\u4E0B\u8F93\u51FA\uFF1A</p><div class="course-code-area"><div class="copy-btn"><div class="copy-icon"></div>\u590D\u5236\u4EE3\u7801</div><pre><code data-language="java"><ol><li><div class="code-word">hello world, start with cluster <span class="hljs-number">4543</span>\r
</div></li><li><div class="code-word">hello world, start with cluster <span class="hljs-number">4542</span>\r
</div></li><li><div class="code-word">hello world, start with cluster <span class="hljs-number">4543</span>\r
</div></li><li><div class="code-word">hello world, start with cluster <span class="hljs-number">4542</span>\r
</div></li></ol></code></pre></div><p data-nodeid="1643">\u540E\u9762\u7684\u8FDB\u7A0B ID \u662F\u6BD4\u8F83\u6709\u89C4\u5F8B\u7684\u968F\u673A\u6570\uFF0C\u6709\u65F6\u5019\u8F93\u51FA 4543\uFF0C\u6709\u65F6\u5019\u8F93\u51FA 4542\uFF0C4543 \u548C 4542 \u5C31\u662F\u6211\u4EEC <strong data-nodeid="1800">fork \u51FA\u6765\u7684\u4E24\u4E2A\u5B50\u8FDB\u7A0B</strong>\uFF0C\u63A5\u4E0B\u6765\u6211\u4EEC\u770B\u4E0B\u4E3A\u4EC0\u4E48\u662F\u8FD9\u6837\u7684\u3002</p><h4 data-nodeid="1644">\u539F\u7406</h4><p data-nodeid="1645">\u9996\u5148\u6211\u4EEC\u9700\u8981\u641E\u6E05\u695A\u4E24\u4E2A\u95EE\u9898\uFF1A</p><ul data-nodeid="1646"><li data-nodeid="1647"><p data-nodeid="1648">Node.js \u7684 cluster \u662F\u5982\u4F55\u505A\u5230\u591A\u4E2A\u8FDB\u7A0B\u76D1\u542C\u4E00\u4E2A\u7AEF\u53E3\u7684\uFF1B</p></li><li data-nodeid="1649"><p data-nodeid="1650">Node.js \u662F\u5982\u4F55\u8FDB\u884C\u8D1F\u8F7D\u5747\u8861\u8BF7\u6C42\u5206\u53D1\u7684\u3002</p></li></ul><p data-nodeid="1651"><strong data-nodeid="1808">\u591A\u8FDB\u7A0B\u7AEF\u53E3\u95EE\u9898</strong></p><p data-nodeid="1652">\u5728 cluster \u6A21\u5F0F\u4E2D\u5B58\u5728 master \u548C worker \u7684\u6982\u5FF5\uFF0C<strong data-nodeid="1818">master \u5C31\u662F\u4E3B\u8FDB\u7A0B</strong>\uFF0C<strong data-nodeid="1819">worker \u5219\u662F\u5B50\u8FDB\u7A0B</strong>\uFF0C\u56E0\u6B64\u8FD9\u91CC\u6211\u4EEC\u9700\u8981\u770B\u4E0B master \u8FDB\u7A0B\u548C worker \u8FDB\u7A0B\u7684\u521B\u5EFA\u65B9\u5F0F\u3002\u5982\u4E0B\u4EE3\u7801\u6240\u793A\uFF1A</p><div class="course-code-area"><div class="copy-btn"><div class="copy-icon"></div>\u590D\u5236\u4EE3\u7801</div><pre><code data-language="javascript"><ol><li><div class="code-word"><span class="hljs-keyword">const</span> cluster = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#39;cluster&#39;</span>);\r
</div></li><li><div class="code-word"><span class="hljs-keyword">const</span> instances = <span class="hljs-number">2</span>; <span class="hljs-comment">// \u542F\u52A8\u8FDB\u7A0B\u6570\u91CF</span>\r
</div></li><li><div class="code-word"><span class="hljs-keyword">if</span> (cluster.isMaster) {\r
</div></li><li><div class="code-word">    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>;i&lt;instances;i++) { <span class="hljs-comment">// \u4F7F\u7528 cluster.fork \u521B\u5EFA\u5B50\u8FDB\u7A0B</span>\r
</div></li><li><div class="code-word">        cluster.fork();\r
</div></li><li><div class="code-word">    }\r
</div></li><li><div class="code-word">} <span class="hljs-keyword">else</span> {\r
</div></li><li><div class="code-word">    <span class="hljs-built_in">require</span>(<span class="hljs-string">&#39;./app.js&#39;</span>);\r
</div></li><li><div class="code-word">}\r
</div></li></ol></code></pre></div><p data-nodeid="1654">\u8FD9\u6BB5\u4EE3\u7801\u4E2D\uFF0C\u7B2C\u4E00\u6B21 require \u7684 cluster \u5BF9\u8C61\u5C31\u9ED8\u8BA4\u662F\u4E00\u4E2A master\uFF0C\u8FD9\u91CC\u7684\u5224\u65AD\u903B\u8F91\u5728<a href="https://github.com/nodejs/node/blob/master/lib/cluster.js" data-nodeid="1823">\u6E90\u7801</a>\u4E2D\uFF0C\u5982\u4E0B\u4EE3\u7801\u6240\u793A\uFF1A</p><div class="course-code-area"><div class="copy-btn"><div class="copy-icon"></div>\u590D\u5236\u4EE3\u7801</div><pre><code data-language="javascript"><ol><li><div class="code-word"><span class="hljs-meta">&#39;use strict&#39;</span>;\r
</div></li><li><div class="code-word">	\r
</div></li><li><div class="code-word">	<span class="hljs-keyword">const</span> childOrPrimary = <span class="hljs-string">&#39;NODE_UNIQUE_ID&#39;</span> <span class="hljs-keyword">in</span> process.env ? <span class="hljs-string">&#39;child&#39;</span> : <span class="hljs-string">&#39;primary&#39;</span>;\r
</div></li><li><div class="code-word">	<span class="hljs-built_in">module</span>.exports = <span class="hljs-built_in">require</span>(<span class="hljs-string">\`internal/cluster/<span class="hljs-subst">\${childOrPrimary}</span>\`</span>);\r
</div></li></ol></code></pre></div><p data-nodeid="1656">\u901A\u8FC7<strong data-nodeid="1830">\u8FDB\u7A0B\u73AF\u5883\u53D8\u91CF\u8BBE\u7F6E</strong>\u6765\u5224\u65AD\uFF1A</p><ul data-nodeid="1657"><li data-nodeid="1658"><p data-nodeid="1659">\u5982\u679C\u6CA1\u6709\u8BBE\u7F6E\u5219\u4E3A master \u8FDB\u7A0B\uFF1B</p></li><li data-nodeid="1660"><p data-nodeid="1661">\u5982\u679C\u6709\u8BBE\u7F6E\u5219\u4E3A\u5B50\u8FDB\u7A0B\u3002</p></li></ul><p data-nodeid="1662">\u56E0\u6B64\u7B2C\u4E00\u6B21\u8C03\u7528 cluster \u6A21\u5757\u662F master \u8FDB\u7A0B\uFF0C\u800C\u540E\u90FD\u662F\u5B50\u8FDB\u7A0B\u3002</p><p data-nodeid="1663">\u4E3B\u8FDB\u7A0B\u548C\u5B50\u8FDB\u7A0B require \u6587\u4EF6\u4E0D\u540C\uFF1A</p><ul data-nodeid="1664"><li data-nodeid="1665"><p data-nodeid="1666">\u524D\u8005\u662F internal/cluster/primary\uFF1B</p></li><li data-nodeid="1667"><p data-nodeid="1668">\u540E\u8005\u662F internal/cluster/child\u3002</p></li></ul><p data-nodeid="1669">\u6211\u4EEC\u5148\u6765\u770B\u4E0B master \u8FDB\u7A0B\u7684\u521B\u5EFA\u8FC7\u7A0B\uFF0C\u8FD9\u90E8\u5206<a href="https://github.com/nodejs/node/blob/7397c7e4a303b1ebad84892872717c0092852921/lib/internal/cluster/primary.js#L60" data-nodeid="1840">\u4EE3\u7801\u5728\u8FD9\u91CC</a>\u3002</p><p data-nodeid="1670">\u53EF\u4EE5\u770B\u5230 cluster.fork\uFF0C\u4E00\u5F00\u59CB\u5C31\u4F1A\u8C03\u7528 setupPrimary \u65B9\u6CD5\uFF0C\u521B\u5EFA\u4E3B\u8FDB\u7A0B\uFF0C\u7531\u4E8E\u8BE5\u65B9\u6CD5\u662F\u901A\u8FC7 cluster.fork \u8C03\u7528\uFF0C\u56E0\u6B64\u4F1A\u8C03\u7528\u591A\u6B21\uFF0C\u4F46\u662F\u8BE5\u6A21\u5757\u6709\u4E2A\u5168\u5C40\u53D8\u91CF initialized \u7528\u6765\u533A\u5206\u662F\u5426\u4E3A\u9996\u6B21\uFF0C\u5982\u679C\u662F\u9996\u6B21\u5219\u521B\u5EFA\uFF0C\u5426\u5219\u5219\u8DF3\u8FC7\uFF0C\u5982\u4E0B\u4EE3\u7801\uFF1A</p><div class="course-code-area"><div class="copy-btn"><div class="copy-icon"></div>\u590D\u5236\u4EE3\u7801</div><pre><code data-language="javascript"><ol><li><div class="code-word">  <span class="hljs-keyword">if</span> (initialized === <span class="hljs-literal">true</span>)\r
</div></li><li><div class="code-word">	    <span class="hljs-keyword">return</span> process.nextTick(setupSettingsNT, settings);\r
</div></li><li><div class="code-word">	\r
</div></li><li><div class="code-word">	  initialized = <span class="hljs-literal">true</span>;\r
</div></li></ol></code></pre></div><p data-nodeid="1672">\u63A5\u4E0B\u6765\u7EE7\u7EED\u770B cluster.fork \u65B9\u6CD5\uFF0C\u6E90\u7801\u5982\u4E0B\uFF1A</p><div class="course-code-area"><div class="copy-btn"><div class="copy-icon"></div>\u590D\u5236\u4EE3\u7801</div><pre><code data-language="javascript"><ol><li><div class="code-word">cluster.fork = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">env</span>) </span>{\r
</div></li><li><div class="code-word">	  cluster.setupPrimary();\r
</div></li><li><div class="code-word">	  <span class="hljs-keyword">const</span> id = ++ids;\r
</div></li><li><div class="code-word">	  <span class="hljs-keyword">const</span> workerProcess = createWorkerProcess(id, env);\r
</div></li><li><div class="code-word">	  <span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> Worker({\r
</div></li><li><div class="code-word">	    <span class="hljs-attr">id</span>: id,\r
</div></li><li><div class="code-word">	    <span class="hljs-attr">process</span>: workerProcess\r
</div></li><li><div class="code-word">	  });\r
</div></li><li><div class="code-word">	\r
</div></li><li><div class="code-word">	  worker.on(<span class="hljs-string">&#39;message&#39;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message, handle</span>) </span>{\r
</div></li><li><div class="code-word">	    cluster.emit(<span class="hljs-string">&#39;message&#39;</span>, <span class="hljs-keyword">this</span>, message, handle);\r
</div></li><li><div class="code-word">	  });\r
</div></li></ol></code></pre></div><p data-nodeid="1674">\u5728\u4E0A\u9762\u4EE3\u7801\u4E2D\u7B2C 2 \u884C\u5C31\u662F<strong data-nodeid="1855">\u521B\u5EFA\u4E3B\u8FDB\u7A0B</strong>\uFF0C\u7B2C 4 \u884C\u5C31\u662F<strong data-nodeid="1856">\u521B\u5EFA worker \u5B50\u8FDB\u7A0B</strong>\uFF0C\u5728\u8FD9\u4E2A createWorkerProcess \u65B9\u6CD5\u4E2D\uFF0C\u6700\u7EC8\u662F\u4F7F\u7528 child_process \u6765\u521B\u5EFA\u5B50\u8FDB\u7A0B\u7684\u3002\u5728\u521D\u59CB\u5316\u4EE3\u7801\u4E2D\uFF0C\u6211\u4EEC\u8C03\u7528\u4E86\u4E24\u6B21 cluster.fork \u65B9\u6CD5\uFF0C\u56E0\u6B64\u4F1A\u521B\u5EFA 2 \u4E2A\u5B50\u8FDB\u7A0B\uFF0C\u5728\u521B\u5EFA\u540E\u53C8\u4F1A\u8C03\u7528\u6211\u4EEC\u9879\u76EE\u6839\u76EE\u5F55\u4E0B\u7684 cluster.js \u542F\u52A8\u4E00\u4E2A\u65B0\u5B9E\u4F8B\uFF0C\u8FD9\u65F6\u5019\u7531\u4E8E cluster.isMaster \u662F false\uFF0C\u56E0\u6B64\u4F1A require \u5230 internal/cluster/child \u8FD9\u4E2A\u65B9\u6CD5\u3002</p><p data-nodeid="1675">\u7531\u4E8E\u662F worker \u8FDB\u7A0B\uFF0C\u56E0\u6B64\u4EE3\u7801\u4F1A require (&#39;./app.js&#39;) \u6A21\u5757\uFF0C\u5728\u8BE5\u6A21\u5757\u4E2D\u4F1A\u76D1\u542C\u5177\u4F53\u7684\u7AEF\u53E3\uFF0C\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="course-code-area"><div class="copy-btn"><div class="copy-icon"></div>\u590D\u5236\u4EE3\u7801</div><pre><code data-language="javascript"><ol><li><div class="code-word"><span class="hljs-comment">/**\r
</span></div></li><li><div class="code-word"> * \r
</div></li><li><div class="code-word"> * \u542F\u52A8\u670D\u52A1\r
</div></li><li><div class="code-word"> */\r
</div></li><li><div class="code-word">server.listen(<span class="hljs-number">3000</span>, () =&gt; {\r
</div></li><li><div class="code-word">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#39;server start http://127.0.0.1:3000&#39;</span>);\r
</div></li><li><div class="code-word">});\r
</div></li><li><div class="code-word"><span class="hljs-built_in">console</span>.log(<span class="hljs-string">\`Worker <span class="hljs-subst">\${process.pid}</span> started\`</span>);\r
</div></li></ol></code></pre></div><p data-nodeid="1677">\u8FD9\u91CC\u7684 server.listen \u65B9\u6CD5\u5F88\u91CD\u8981\uFF0C\u8FD9\u90E8\u5206<a href="https://github.com/nodejs/node/blob/15164cebcebfcad9822d3f065234a8c1511776a4/lib/net.js" data-nodeid="1865">\u6E90\u4EE3\u7801\u5728\u8FD9\u91CC</a>\uFF0C\u5176\u4E2D\u7684 server.listen \u4F1A\u8C03\u7528\u8BE5\u6A21\u5757\u4E2D\u7684 listenInCluster \u65B9\u6CD5\uFF0C\u8BE5\u65B9\u6CD5\u4E2D\u6709\u4E00\u4E2A\u5173\u952E\u4FE1\u606F\uFF0C\u5982\u4E0B\u4EE3\u7801\u6240\u793A\uFF1A</p><div class="course-code-area"><div class="copy-btn"><div class="copy-icon"></div>\u590D\u5236\u4EE3\u7801</div><pre><code data-language="javascript"><ol><li><div class="code-word"><span class="hljs-keyword">if</span> (cluster.isPrimary || exclusive) {\r
</div></li><li><div class="code-word">	    <span class="hljs-comment">// Will create a new handle</span>\r
</div></li><li><div class="code-word">	    <span class="hljs-comment">// _listen2 sets up the listened handle, it is still named like this</span>\r
</div></li><li><div class="code-word">	    <span class="hljs-comment">// to avoid breaking code that wraps this method</span>\r
</div></li><li><div class="code-word">	    server._listen2(address, port, addressType, backlog, fd, flags);\r
</div></li><li><div class="code-word">	    <span class="hljs-keyword">return</span>;\r
</div></li><li><div class="code-word">	  }\r
</div></li><li><div class="code-word">	\r
</div></li><li><div class="code-word">	  <span class="hljs-keyword">const</span> serverQuery = {\r
</div></li><li><div class="code-word">	    <span class="hljs-attr">address</span>: address,\r
</div></li><li><div class="code-word">	    <span class="hljs-attr">port</span>: port,\r
</div></li><li><div class="code-word">	    <span class="hljs-attr">addressType</span>: addressType,\r
</div></li><li><div class="code-word">	    <span class="hljs-attr">fd</span>: fd,\r
</div></li><li><div class="code-word">	    flags,\r
</div></li><li><div class="code-word">	  };\r
</div></li><li><div class="code-word">	\r
</div></li><li><div class="code-word">	  <span class="hljs-comment">// Get the primary&#39;s server handle, and listen on it</span>\r
</div></li><li><div class="code-word">	  cluster._getServer(server, serverQuery, listenOnPrimaryHandle);\r
</div></li></ol></code></pre></div><p data-nodeid="1679">\u4E0A\u9762\u4EE3\u7801\u4E2D\u7684\u7B2C 6 \u884C\uFF0C\u5224\u65AD\u4E3A<strong data-nodeid="1880">\u4E3B\u8FDB\u7A0B</strong>\uFF0C\u5C31\u662F<strong data-nodeid="1881">\u771F\u5B9E\u7684\u76D1\u542C\u7AEF\u53E3\u542F\u52A8\u670D\u52A1</strong>\uFF0C\u800C\u5982\u679C\u975E\u4E3B\u8FDB\u7A0B\u5219\u8C03\u7528 cluster._getServer \u65B9\u6CD5\uFF0C\u4E5F\u5C31\u662F internal/cluster/child \u4E2D\u7684 cluster._getServer \u65B9\u6CD5\u3002</p><p data-nodeid="1680">\u63A5\u4E0B\u6765\u6211\u4EEC\u770B\u4E0B\u8FD9\u90E8\u5206\u4EE3\u7801\uFF1A</p><div class="course-code-area"><div class="copy-btn"><div class="copy-icon"></div>\u590D\u5236\u4EE3\u7801</div><pre><code data-language="javascript"><ol><li><div class="code-word">obj.once(<span class="hljs-string">&#39;listening&#39;</span>, () =&gt; {\r
</div></li><li><div class="code-word">	    cluster.worker.state = <span class="hljs-string">&#39;listening&#39;</span>;\r
</div></li><li><div class="code-word">	    <span class="hljs-keyword">const</span> address = obj.address();\r
</div></li><li><div class="code-word">	    message.act = <span class="hljs-string">&#39;listening&#39;</span>;\r
</div></li><li><div class="code-word">	    message.port = (address &amp;&amp; address.port) || options.port;\r
</div></li><li><div class="code-word">	    send(message);\r
</div></li><li><div class="code-word">	  });\r
</div></li></ol></code></pre></div><p data-nodeid="1682">\u8FD9\u4E00\u4EE3\u7801\u901A\u8FC7 send \u65B9\u6CD5\uFF0C\u5982\u679C\u76D1\u542C\u5230 listening \u53D1\u9001\u4E00\u4E2A\u6D88\u606F\u7ED9\u5230\u4E3B\u8FDB\u7A0B\uFF0C\u4E3B\u8FDB\u7A0B\u4E5F\u6709\u4E00\u4E2A\u540C\u6837\u7684 listening \u4E8B\u4EF6\uFF0C\u76D1\u542C\u5230\u8BE5\u4E8B\u4EF6\u540E\u5C06\u5B50\u8FDB\u7A0B\u901A\u8FC7 EventEmitter \u7ED1\u5B9A\u5728\u4E3B\u8FDB\u7A0B\u4E0A\uFF0C\u8FD9\u6837\u5C31\u5B8C\u6210\u4E86\u4E3B\u5B50\u8FDB\u7A0B\u4E4B\u95F4\u7684<strong data-nodeid="1892">\u5173\u8054\u7ED1\u5B9A</strong>\uFF0C\u5E76\u4E14\u53EA\u76D1\u542C\u4E86\u4E00\u4E2A\u7AEF\u53E3\u3002\u800C\u4E3B\u5B50\u8FDB\u7A0B\u4E4B\u95F4\u7684\u901A\u4FE1\u65B9\u5F0F\uFF0C\u5C31\u662F\u6211\u4EEC\u5E38\u542C\u5230\u7684 <strong data-nodeid="1893">IPC \u901A\u4FE1\u65B9\u5F0F</strong>\u3002</p><p data-nodeid="1683"><strong data-nodeid="1897">\u8D1F\u8F7D\u5747\u8861\u539F\u7406</strong></p><p data-nodeid="1684">\u65E2\u7136 Node.js cluster \u6A21\u5757\u4F7F\u7528\u7684\u662F\u4E3B\u5B50\u8FDB\u7A0B\u65B9\u5F0F\uFF0C\u90A3\u4E48\u5B83\u662F\u5982\u4F55\u8FDB\u884C\u8D1F\u8F7D\u5747\u8861\u5904\u7406\u7684\u5462\uFF0C\u8FD9\u91CC\u5C31\u4F1A\u6D89\u53CA Node.js cluster \u6A21\u5757\u4E2D\u7684\u4E24\u4E2A\u6A21\u5757\u3002</p><ul data-nodeid="1685"><li data-nodeid="1686"><p data-nodeid="1687"><a href="https://github.com/nodejs/node/blob/7397c7e4a303b1ebad84892872717c0092852921/lib/internal/cluster/round_robin_handle.js" data-nodeid="1905">round_robin_handle.js</a>\uFF08\u975E Windows \u5E73\u53F0\u5E94\u7528\u6A21\u5F0F\uFF09\uFF0C\u8FD9\u662F\u4E00\u4E2A<strong data-nodeid="1911">\u8F6E\u8BE2\u5904\u7406\u6A21\u5F0F</strong>\uFF0C\u4E5F\u5C31\u662F\u8F6E\u8BE2\u8C03\u5EA6\u5206\u53D1\u7ED9\u7A7A\u95F2\u7684\u5B50\u8FDB\u7A0B\uFF0C\u5904\u7406\u5B8C\u6210\u540E\u56DE\u5230 worker \u7A7A\u95F2\u6C60\u5B50\u4E2D\uFF0C\u8FD9\u91CC\u8981\u6CE8\u610F\u7684\u5C31\u662F\u5982\u679C\u7ED1\u5B9A\u8FC7\u5C31\u4F1A\u590D\u7528\u8BE5\u5B50\u8FDB\u7A0B\uFF0C\u5982\u679C\u6CA1\u6709\u5219\u4F1A\u91CD\u65B0\u5224\u65AD\uFF0C\u8FD9\u91CC\u53EF\u4EE5\u901A\u8FC7\u4E0A\u9762\u7684 app.js \u4EE3\u7801\u6765\u6D4B\u8BD5\uFF0C\u7528\u6D4F\u89C8\u5668\u53BB\u8BBF\u95EE\uFF0C\u4F60\u4F1A\u53D1\u73B0\u6BCF\u6B21\u8C03\u7528\u7684\u5B50\u8FDB\u7A0B ID \u90FD\u4F1A\u4E0D\u53D8\u3002</p></li><li data-nodeid="1688"><p data-nodeid="1689"><a href="https://github.com/nodejs/node/blob/7397c7e4a303b1ebad84892872717c0092852921/lib/internal/cluster/shared_handle.js" data-nodeid="1916">shared_handle.js</a>\uFF08 Windows \u5E73\u53F0\u5E94\u7528\u6A21\u5F0F\uFF09\uFF0C\u901A\u8FC7\u5C06\u6587\u4EF6\u63CF\u8FF0\u7B26\u3001\u7AEF\u53E3\u7B49\u4FE1\u606F\u4F20\u9012\u7ED9\u5B50\u8FDB\u7A0B\uFF0C\u5B50\u8FDB\u7A0B\u901A\u8FC7\u4FE1\u606F\u521B\u5EFA\u76F8\u5E94\u7684 SocketHandle / ServerHandle\uFF0C\u7136\u540E\u8FDB\u884C\u76F8\u5E94\u7684\u7AEF\u53E3\u7ED1\u5B9A\u548C\u76D1\u542C\u3001\u5904\u7406\u8BF7\u6C42\u3002</p></li></ul><p data-nodeid="1690">\u4EE5\u4E0A\u5C31\u662F cluster \u7684\u539F\u7406\uFF0C\u603B\u7ED3\u4E00\u4E0B\u5C31\u662F cluster \u6A21\u5757\u5E94\u7528 child_process \u6765\u521B\u5EFA\u5B50\u8FDB\u7A0B\uFF0C\u5B50\u8FDB\u7A0B\u901A\u8FC7\u590D\u5199\u6389 cluster._getServer \u65B9\u6CD5\uFF0C\u4ECE\u800C\u5728 server.listen \u6765\u4FDD\u8BC1\u53EA\u6709\u4E3B\u8FDB\u7A0B\u76D1\u542C\u7AEF\u53E3\uFF0C\u4E3B\u5B50\u8FDB\u7A0B\u901A\u8FC7 IPC \u8FDB\u884C\u901A\u4FE1\uFF0C\u5176\u6B21\u4E3B\u8FDB\u7A0B\u6839\u636E\u5E73\u53F0\u6216\u8005\u534F\u8BAE\u4E0D\u540C\uFF0C\u5E94\u7528\u4E24\u79CD\u4E0D\u540C\u6A21\u5757\uFF08round_robin_handle.js \u548C shared_handle.js\uFF09\u8FDB\u884C\u8BF7\u6C42\u5206\u53D1\u7ED9\u5B50\u8FDB\u7A0B\u5904\u7406\u3002\u63A5\u4E0B\u6765\u6211\u4EEC\u770B\u4E00\u4E0B cluster \u7684\u6210\u719F\u7684\u5E94\u7528\u5DE5\u5177 PM2 \u7684\u5E94\u7528\u548C\u539F\u7406\u3002</p><h3 data-nodeid="1691">PM2 \u539F\u7406</h3><p data-nodeid="1692">PM2 \u662F<strong data-nodeid="1935">\u5B88\u62A4\u8FDB\u7A0B\u7BA1\u7406\u5668</strong>\uFF0C\u53EF\u4EE5\u5E2E\u52A9\u4F60\u7BA1\u7406\u548C\u4FDD\u6301\u5E94\u7528\u7A0B\u5E8F\u5728\u7EBF\u3002PM2 \u5165\u95E8\u975E\u5E38\u7B80\u5355\uFF0C\u5B83\u662F\u4E00\u4E2A\u7B80\u5355\u76F4\u89C2\u7684 CLI \u5DE5\u5177\uFF0C\u53EF\u4EE5\u901A\u8FC7 NPM \u5B89\u88C5\uFF0C\u63A5\u4E0B\u6765\u6211\u4EEC\u770B\u4E0B\u4E00\u4E9B\u7B80\u5355\u7684\u7528\u6CD5\u3002</p><h4 data-nodeid="1693">\u5E94\u7528</h4><p data-nodeid="1694">\u4F60\u53EF\u4EE5\u4F7F\u7528\u5982\u4E0B\u547D\u4EE4\u8FDB\u884C NPM \u6216\u8005 Yarn \u7684\u5B89\u88C5\uFF1A</p><div class="course-code-area"><div class="copy-btn"><div class="copy-icon"></div>\u590D\u5236\u4EE3\u7801</div><pre><code data-language="java"><ol><li><div class="code-word">$ npm install pm2@latest -g\r
</div></li><li><div class="code-word"># or\r
</div></li><li><div class="code-word">$ yarn global add pm2\r
</div></li></ol></code></pre></div><p data-nodeid="1696">\u5B89\u88C5\u6210\u529F\u540E\uFF0C\u53EF\u4EE5\u4F7F\u7528\u5982\u4E0B\u547D\u4EE4\u67E5\u770B\u662F\u5426\u5B89\u88C5\u6210\u529F\u4EE5\u53CA\u5F53\u524D\u7684\u7248\u672C\uFF1A</p><div class="course-code-area"><div class="copy-btn"><div class="copy-icon"></div>\u590D\u5236\u4EE3\u7801</div><pre><code data-language="java"><ol><li><div class="code-word">$\xA0pm2 --version\r
</div></li></ol></code></pre></div><p data-nodeid="1698">\u63A5\u4E0B\u6765\u6211\u4EEC\u4F7F\u7528 PM2 \u542F\u52A8\u4E00\u4E2A\u7B80\u5355\u7684 Node.js \u9879\u76EE\uFF0C\u8FDB\u5165\u672C\u8BB2\u4EE3\u7801\u7684\u9879\u76EE\u6839\u76EE\u5F55\uFF0C\u7136\u540E\u8FD0\u884C\u4E0B\u9762\u547D\u4EE4\uFF1A</p><div class="course-code-area"><div class="copy-btn"><div class="copy-icon"></div>\u590D\u5236\u4EE3\u7801</div><pre><code data-language="java"><ol><li><div class="code-word">$\xA0pm2 start app.js\r
</div></li></ol></code></pre></div><p data-nodeid="1700">\u8FD0\u884C\u540E\uFF0C\u518D\u6267\u884C\u5982\u4E0B\u547D\u4EE4\uFF1A</p><div class="course-code-area"><div class="copy-btn"><div class="copy-icon"></div>\u590D\u5236\u4EE3\u7801</div><pre><code data-language="java"><ol><li><div class="code-word">$\xA0pm2\xA0list\r
</div></li></ol></code></pre></div><p data-nodeid="1702">\u53EF\u4EE5\u770B\u5230\u5982\u56FE 2 \u6240\u793A\u7684\u7ED3\u679C\uFF0C\u4EE3\u8868\u8FD0\u884C\u6210\u529F\u4E86\u3002</p><p data-nodeid="1703"><img src="https://s0.lgstatic.com/i/image6/M01/1D/E3/Cgp9HWBQKZeAM-MIAAB0_RHaw1E022.png" alt="Drawing 2.png" data-nodeid="1944"></p><div data-nodeid="1704"><p style="text-align:center;">\u56FE 2 pm2 list \u8FD0\u884C\u7ED3\u679C</p></div><p data-nodeid="1705">PM2 \u542F\u52A8\u65F6\u53EF\u4EE5\u5E26\u4E00\u4E9B\u914D\u7F6E\u5316\u53C2\u6570\uFF0C\u5177\u4F53\u53C2\u6570\u5217\u8868\u4F60\u53EF\u4EE5\u53C2\u8003<a href="https://pm2.keymetrics.io/docs/usage/pm2-doc-single-page/" data-nodeid="1948">\u5B98\u65B9\u6587\u6863</a>\u3002\u5728\u5F00\u53D1\u4E2D\u6211\u603B\u7ED3\u51FA\u4E86\u4E00\u5957\u6700\u4F73\u7684\u5B9E\u8DF5\uFF0C\u5982\u4EE5\u4E0B\u914D\u7F6E\u6240\u793A\uFF1A</p><div class="course-code-area"><div class="copy-btn"><div class="copy-icon"></div>\u590D\u5236\u4EE3\u7801</div><pre><code data-language="javascript"><ol><li><div class="code-word"><span class="hljs-built_in">module</span>.exports = {\r
</div></li><li><div class="code-word">    <span class="hljs-attr">apps</span> : [{\r
</div></li><li><div class="code-word">      <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;nodejs-column&quot;</span>, <span class="hljs-comment">// \u542F\u52A8\u8FDB\u7A0B\u540D</span>\r
</div></li><li><div class="code-word">      <span class="hljs-attr">script</span>: <span class="hljs-string">&quot;./app.js&quot;</span>, <span class="hljs-comment">// \u542F\u52A8\u6587\u4EF6</span>\r
</div></li><li><div class="code-word">      <span class="hljs-attr">instances</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// \u542F\u52A8\u8FDB\u7A0B\u6570</span>\r
</div></li><li><div class="code-word">      <span class="hljs-attr">exec_mode</span>: <span class="hljs-string">&#39;cluster&#39;</span>, <span class="hljs-comment">// \u591A\u8FDB\u7A0B\u591A\u5B9E\u4F8B</span>\r
</div></li><li><div class="code-word">      <span class="hljs-attr">env_development</span>: {\r
</div></li><li><div class="code-word">        <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&quot;development&quot;</span>,\r
</div></li><li><div class="code-word">        <span class="hljs-attr">watch</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// \u5F00\u53D1\u73AF\u5883\u4F7F\u7528 true\uFF0C\u5176\u4ED6\u5FC5\u987B\u8BBE\u7F6E\u4E3A false</span>\r
</div></li><li><div class="code-word">      },\r
</div></li><li><div class="code-word">      <span class="hljs-attr">env_testing</span>: {\r
</div></li><li><div class="code-word">        <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&quot;testing&quot;</span>,\r
</div></li><li><div class="code-word">        <span class="hljs-attr">watch</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// \u5F00\u53D1\u73AF\u5883\u4F7F\u7528 true\uFF0C\u5176\u4ED6\u5FC5\u987B\u8BBE\u7F6E\u4E3A false</span>\r
</div></li><li><div class="code-word">      },\r
</div></li><li><div class="code-word">      <span class="hljs-attr">env_production</span>: {\r
</div></li><li><div class="code-word">        <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&quot;production&quot;</span>,\r
</div></li><li><div class="code-word">        <span class="hljs-attr">watch</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// \u5F00\u53D1\u73AF\u5883\u4F7F\u7528 true\uFF0C\u5176\u4ED6\u5FC5\u987B\u8BBE\u7F6E\u4E3A false</span>\r
</div></li><li><div class="code-word">      },\r
</div></li><li><div class="code-word">      <span class="hljs-attr">log_date_format</span>: <span class="hljs-string">&#39;YYYY-MM-DD HH:mm Z&#39;</span>,\r
</div></li><li><div class="code-word">      <span class="hljs-attr">error_file</span>: <span class="hljs-string">&#39;~/data/err.log&#39;</span>, <span class="hljs-comment">// \u9519\u8BEF\u65E5\u5FD7\u6587\u4EF6\uFF0C\u5FC5\u987B\u8BBE\u7F6E\u5728\u9879\u76EE\u5916\u7684\u76EE\u5F55\uFF0C\u8FD9\u91CC\u4E3A\u4E86\u6D4B\u8BD5</span>\r
</div></li><li><div class="code-word">      <span class="hljs-attr">out_file</span>: <span class="hljs-string">&#39;~/data/info.log&#39;</span>, <span class="hljs-comment">//  \u6D41\u6C34\u65E5\u5FD7\uFF0C\u5305\u62EC console.log \u65E5\u5FD7\uFF0C\u5FC5\u987B\u8BBE\u7F6E\u5728\u9879\u76EE\u5916\u7684\u76EE\u5F55\uFF0C\u8FD9\u91CC\u4E3A\u4E86\u6D4B\u8BD5</span>\r
</div></li><li><div class="code-word">      <span class="hljs-attr">max_restarts</span>: <span class="hljs-number">10</span>,\r
</div></li><li><div class="code-word">    }]\r
</div></li><li><div class="code-word">  }\r
</div></li></ol></code></pre></div><p data-nodeid="3650" class="te-preview-highlight">\u5728\u4E0A\u9762\u7684\u914D\u7F6E\u4E2D\u8981\u7279\u522B\u6CE8\u610F <strong data-nodeid="3664">error_file</strong> \u548C <strong data-nodeid="3665">out_file</strong>\uFF0C\u8FD9\u91CC\u7684\u65E5\u5FD7\u76EE\u5F55\u5728\u9879\u76EE\u521D\u59CB\u5316\u65F6\u8981\u521B\u5EFA\u597D\uFF0C\u5982\u679C\u4E0D\u63D0\u524D\u521B\u5EFA\u597D\u4F1A\u5BFC\u81F4\u7EBF\u4E0A\u8FD0\u884C\u5931\u8D25\uFF0C\u7279\u522B\u662F\u65E0\u6743\u9650\u521B\u5EFA\u76EE\u5F55\u65F6\u3002\u5176\u6B21\u5982\u679C\u5B58\u5728\u73AF\u5883\u5DEE\u5F02\u7684\u914D\u7F6E\u65F6\uFF0C\u53EF\u4EE5\u653E\u7F6E\u5728\u4E0D\u540C\u7684\u73AF\u5883\u4E0B\uFF0C\u6700\u7EC8\u53EF\u4EE5\u4F7F\u7528\u4E0B\u9762\u4E09\u79CD\u65B9\u5F0F\u6765\u542F\u52A8\u9879\u76EE\uFF0C\u5206\u522B\u5BF9\u5E94\u4E0D\u540C\u73AF\u5883\u3002</p><div class="course-code-area"><div class="copy-btn"><div class="copy-icon"></div>\u590D\u5236\u4EE3\u7801</div><pre><code data-language="shell"><ol><li><div class="code-word"><span class="hljs-meta">$</span><span class="bash"> pm2 start pm2.config.js --env development</span>\r
</div></li><li><div class="code-word"><span class="hljs-meta">$</span><span class="bash"> pm2 start pm2.config.js --env testing</span>\r
</div></li><li><div class="code-word"><span class="hljs-meta">$</span><span class="bash"> pm2 start pm2.config.js --env production</span>\r
</div></li></ol></code></pre></div><h4 data-nodeid="1709">\u539F\u7406</h4><p data-nodeid="1710">\u63A5\u4E0B\u6765\u6211\u4EEC\u6765\u770B\u4E0B\u662F\u5982\u4F55\u5B9E\u73B0\u7684\uFF0C\u7531\u4E8E\u6574\u4E2A\u9879\u76EE\u662F\u6BD4\u8F83\u590D\u6742\u5E9E\u5927\u7684\uFF0C\u8FD9\u91CC\u6211\u4EEC\u4E3B\u8981\u5173\u6CE8<strong data-nodeid="1971">\u8FDB\u7A0B\u521B\u5EFA\u7BA1\u7406\u7684\u539F\u7406</strong>\u3002</p><p data-nodeid="1711">\u9996\u5148\u6211\u4EEC\u6765\u770B\u4E0B\u8FDB\u7A0B\u521B\u5EFA\u7684\u65B9\u5F0F\uFF0C\u6574\u4F53\u7684\u6D41\u7A0B\u5982\u56FE 3 \u6240\u793A\u3002</p><p data-nodeid="1712"><img src="https://s0.lgstatic.com/i/image6/M01/1D/E0/CioPOWBQKaWAHrR1AAKhg2CW1Z0319.png" alt="Drawing 3.png" data-nodeid="1975"></p><div data-nodeid="1713"><p style="text-align:center;">\u56FE 3 PM2 \u6E90\u7801\u591A\u8FDB\u7A0B\u521B\u5EFA\u65B9\u5F0F</p></div><p data-nodeid="1714">\u8FD9\u4E00\u65B9\u5F0F\u6D89\u53CA\u4E94\u4E2A\u6A21\u5757\u6587\u4EF6\u3002</p><ul data-nodeid="1715"><li data-nodeid="1716"><p data-nodeid="1717">CLI\uFF08lib/binaries/CLI.js\uFF09\u5904\u7406\u547D\u4EE4\u884C\u8F93\u5165\uFF0C\u5982\u6211\u4EEC\u8FD0\u884C\u7684\u547D\u4EE4\uFF1A</p></li></ul><div class="course-code-area"><div class="copy-btn"><div class="copy-icon"></div>\u590D\u5236\u4EE3\u7801</div><pre><code data-language="java"><ol><li><div class="code-word">pm2 start pm2.config.js --env development\r
</div></li></ol></code></pre></div><ul data-nodeid="1719"><li data-nodeid="1720"><p data-nodeid="1721">API\uFF08lib/API.js\uFF09\u5BF9\u5916\u66B4\u9732\u7684\u5404\u79CD\u547D\u4EE4\u884C\u8C03\u7528\u65B9\u6CD5\uFF0C\u6BD4\u5982\u4E0A\u9762\u7684 start \u547D\u4EE4\u5BF9\u5E94\u7684 API-&gt;start \u65B9\u6CD5\u3002</p></li><li data-nodeid="1722"><p data-nodeid="1723">Client \uFF08lib/Client.js\uFF09\u53EF\u4EE5\u7406\u89E3\u4E3A\u547D\u4EE4\u884C\u63A5\u6536\u7AEF\uFF0C\u8D1F\u8D23\u521B\u5EFA\u5B88\u62A4\u8FDB\u7A0B Daemon\uFF0C\u5E76\u4E0E Daemon\uFF08lib/Daemon.js\uFF09\u4FDD\u6301 RPC \u8FDE\u63A5\u3002</p></li><li data-nodeid="1724"><p data-nodeid="1725">God \uFF08lib/God.js\uFF09\u4E3B\u8981\u8D1F\u8D23\u8FDB\u7A0B\u7684\u521B\u5EFA\u548C\u7BA1\u7406\uFF0C\u4E3B\u8981\u662F\u901A\u8FC7 Daemon \u8C03\u7528\uFF0CClient \u6240\u6709\u8C03\u7528\u90FD\u662F\u901A\u8FC7 RPC \u8C03\u7528 Daemon\uFF0C\u7136\u540E Daemon \u8C03\u7528 God \u4E2D\u7684\u65B9\u6CD5\u3002</p></li><li data-nodeid="1726"><p data-nodeid="1727">\u6700\u7EC8\u5728 God \u4E2D\u8C03\u7528 ClusterMode\uFF08lib/God/ClusterMode.js\uFF09\u6A21\u5757\uFF0C\u5728 ClusterMode \u4E2D\u8C03\u7528 Node.js \u7684 cluster.fork \u521B\u5EFA\u5B50\u8FDB\u7A0B\u3002</p></li></ul><p data-nodeid="1728">\u56FE 3 \u4E2D\u9996\u5148\u901A\u8FC7\u547D\u4EE4\u884C\u89E3\u6790\u8C03\u7528 API\uFF0CAPI \u4E2D\u7684\u65B9\u6CD5\u57FA\u672C\u4E0A\u662F\u4E0E CLI \u4E2D\u7684\u547D\u4EE4\u884C\u4E00\u4E00\u5BF9\u5E94\u7684\uFF0CAPI \u4E2D\u7684 start \u65B9\u6CD5\u4F1A\u6839\u636E\u4F20\u5165\u53C2\u6570\u5224\u65AD\u662F\u5426\u662F\u8C03\u7528\u7684\u65B9\u6CD5\uFF0C\u4E00\u822C\u60C5\u51B5\u4E0B\u4F7F\u7528\u7684\u90FD\u662F\u4E00\u4E2A JSON \u914D\u7F6E\u6587\u4EF6\uFF0C\u56E0\u6B64\u8C03\u7528 API \u4E2D\u7684\u79C1\u6709\u65B9\u6CD5 _startJson\u3002</p><p data-nodeid="1729">\u63A5\u4E0B\u6765\u5C31\u5F00\u59CB\u5728 Client \u6A21\u5757\u4E2D\u6D41\u8F6C\u4E86\uFF0C\u5728 _startJson \u4E2D\u4F1A\u8C03\u7528 executeRemote \u65B9\u6CD5\uFF0C\u8BE5\u65B9\u6CD5\u4F1A\u5148\u5224\u65AD PM2 \u7684\u5B88\u62A4\u8FDB\u7A0B Daemon \u662F\u5426\u542F\u52A8\uFF0C\u5982\u679C\u6CA1\u6709\u542F\u52A8\u4F1A\u5148\u8C03\u7528 Daemon \u6A21\u5757\u4E2D\u7684\u65B9\u6CD5\u542F\u52A8\u5B88\u62A4\u8FDB\u7A0B RPC \u670D\u52A1\uFF0C\u542F\u52A8\u6210\u529F\u540E\u518D\u901A\u77E5 Client \u5E76\u5EFA\u7ACB RPC \u901A\u4FE1\u8FDE\u63A5\u3002</p><p data-nodeid="1730">\u6210\u529F\u5EFA\u7ACB\u8FDE\u63A5\u540E\uFF0CClient \u4F1A\u53D1\u9001\u542F\u52A8 Node.js \u5B50\u8FDB\u7A0B\u7684\u547D\u4EE4 prepare\uFF0C\u8BE5\u547D\u4EE4\u4F20\u9012 Daemon\uFF0CDaemon \u4E2D\u6709\u4E00\u4EFD\u5BF9\u5E94\u7684\u547D\u4EE4\u7684\u6267\u884C\u65B9\u6CD5\uFF0C\u8BE5\u547D\u4EE4\u6700\u7EC8\u4F1A\u8C03\u7528 God \u4E2D\u7684 prepare \u65B9\u6CD5\u3002</p><p data-nodeid="1731">\u5728 God \u4E2D\u6700\u7EC8\u4F1A\u8C03\u7528 God \u6587\u4EF6\u5939\u4E0B\u7684 ClusterMode \u6A21\u5757\uFF0C\u5E94\u7528 Node.js \u7684 cluster.fork \u521B\u5EFA\u5B50\u8FDB\u7A0B\uFF0C\u8FD9\u6837\u5C31\u5B8C\u6210\u4E86\u6574\u4E2A\u542F\u52A8\u8FC7\u7A0B\u3002</p><p data-nodeid="1732">\u7EFC\u4E0A\u6240\u8FF0\uFF0CPM2 \u901A\u8FC7\u547D\u4EE4\u884C\uFF0C\u4F7F\u7528 RPC \u5EFA\u7ACB Client \u4E0E Daemon \u8FDB\u7A0B\u4E4B\u95F4\u7684\u901A\u4FE1\uFF0C\u901A\u8FC7 RPC \u901A\u4FE1\u65B9\u5F0F\uFF0C\u8C03\u7528 God\uFF0C\u4ECE\u800C\u5E94\u7528 Node.js \u7684 cluster.fork \u521B\u5EFA\u5B50\u8FDB\u7A0B\u7684\u3002\u4EE5\u4E0A\u662F\u542F\u52A8\u7684\u6D41\u7A0B\uFF0C\u5BF9\u4E8E\u5176\u4ED6\u547D\u4EE4\u6307\u4EE4\uFF0C\u6BD4\u5982 stop\u3001restart \u7B49\uFF0C\u4E5F\u662F\u4E00\u6837\u7684\u901A\u4FE1\u6D41\u8F6C\u8FC7\u7A0B\uFF0C\u4F60\u53C2\u7167\u4E0A\u9762\u7684\u6D41\u7A0B\u5206\u6790\u5C31\u53EF\u4EE5\u4E86\uFF0C\u5982\u679C\u9047\u5230\u4EFB\u4F55\u95EE\u9898\uFF0C\u90FD\u53EF\u4EE5\u5728\u7559\u8A00\u533A\u4E0E\u6211\u4EA4\u6D41\u3002</p><blockquote data-nodeid="1733"><p data-nodeid="1734">\u4EE5\u4E0A\u7684\u5206\u6790\u4F60\u9700\u8981\u53C2\u8003<a href="https://github.com/Unitech/pm2/tree/64f8ea0f2c31c7d70a415eccc6222547b3664e65" data-nodeid="1994">PM2 \u7684 GitHub \u6E90\u7801</a>\u3002</p></blockquote><h3 data-nodeid="1735">\u603B\u7ED3</h3><p data-nodeid="1736">\u672C\u8BB2\u4E3B\u8981\u4ECB\u7ECD\u4E86 Node.js \u4E2D\u7684 cluster \u6A21\u5757\uFF0C\u5E76\u6DF1\u5165\u4ECB\u7ECD\u4E86\u5176\u6838\u5FC3\u539F\u7406\uFF0C\u5176\u6B21\u4ECB\u7ECD\u4E86\u76EE\u524D\u6BD4\u8F83\u5E38\u7528\u7684\u591A\u8FDB\u7A0B\u7BA1\u7406\u5DE5\u5177 PM2 \u7684\u5E94\u7528\u548C\u539F\u7406\u3002\u5B66\u5B8C\u672C\u8BB2\u540E\uFF0C\u9700\u8981\u638C\u63E1 Node.js cluster \u539F\u7406\uFF0C\u5E76\u4E14\u638C\u63E1 PM2 \u7684\u5B9E\u73B0\u539F\u7406\u3002</p><p data-nodeid="1737">\u63A5\u4E0B\u6765\u6211\u4EEC\u5C06\u5F00\u59CB\u8BB2\u89E3\u4E00\u4E9B\u5173\u4E8E Node.js \u6027\u80FD\u76F8\u5173\u7684\u77E5\u8BC6\uFF0C\u4E3A\u540E\u7EED\u7684\u9AD8\u6027\u80FD\u670D\u52A1\u505A\u4E00\u5B9A\u7684\u51C6\u5907\uFF0C\u5176\u6B21\u4E5F\u5728\u4E3A\u540E\u7EED\u6027\u80FD\u4F18\u5316\u6253\u4E0B\u4E00\u5B9A\u7684\u6280\u672F\u57FA\u7840\u3002</p><p data-nodeid="1738">\u4E0B\u4E00\u8BB2\u4F1A\u8BB2\u89E3\uFF0C\u76EE\u524D\u6211\u4EEC\u5728\u4F7F\u7528\u7684 Node.js cluster \u6A21\u5F0F\u5B58\u5728\u7684\u6027\u80FD\u95EE\u9898\u3002</p><hr data-nodeid="1739"><p data-nodeid="1740"><a href="https://shenceyun.lagou.com/t/mka" data-nodeid="2004"><img src="https://s0.lgstatic.com/i/image6/M00/12/FA/CioPOWBBrAKAAod-AASyC72ZqWw233.png" alt="Drawing 2.png" data-nodeid="2003"></a></p><p data-nodeid="1741"><strong data-nodeid="2008">\u300A\u5927\u524D\u7AEF\u9AD8\u85AA\u8BAD\u7EC3\u8425\u300B</strong></p><p data-nodeid="1742" class="">\u5BF9\u6807\u963F\u91CC P7 \u6280\u672F\u9700\u6C42 + \u6BCF\u6708\u5927\u5382\u5185\u63A8\uFF0C6 \u4E2A\u6708\u52A9\u4F60\u65A9\u83B7\u540D\u4F01\u9AD8\u85AA Offer\u3002<a href="https://shenceyun.lagou.com/t/mka" data-nodeid="2012">\u70B9\u51FB\u94FE\u63A5</a>\uFF0C\u5FEB\u6765\u9886\u53D6\uFF01</p></div></div>`,2),u=[r,t,c,p,v,h];function j(g,w){return d(),i("div",o,u)}var y=e(n,[["render",j]]);export{y as default};
